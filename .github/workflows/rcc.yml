name: RCC files

on: [push, pull_request]

jobs:
  rcc-compile:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@master
        with:
          submodules: recursive
          
      - name: Install Dependencys
        run: sudo apt install qtbase5-dev-tools pngcrush
        
      - name: Crush all the files
        if: github.ref == 'refs/heads/master'
        run: find . -iname '*png' -exec pngcrush -ow -brute {} {}.crush \;

      - name: default RCC
        run: |
          echo '<!DOCTYPE RCC><RCC version="1.0">' > ./default/theme.qrc
          echo '<qresource prefix="/base/themes/default">' >> ./default/theme.qrc
          echo '    <file>charselect.ui</file>' >> ./default/theme.qrc
          echo '    <file>direct_connect_dialog.ui</file>' >> ./default/theme.qrc
          echo '    <file>favorite_server_dialog.ui</file>' >> ./default/theme.qrc
          echo '    <file>lobby.ui</file>' >> ./default/theme.qrc
          echo '    <file>options_dialog.ui</file>' >> ./default/theme.qrc
          echo '    <file>version</file>' >> ./default/theme.qrc
          echo '    <file>lobby_assets/down-arrow.png</file>' >> ./default/theme.qrc
          echo '    <file>lobby_assets/up-arrow.png</file>' >> ./default/theme.qrc
          echo '</qresource>' >> ./default/theme.qrc
          echo '</RCC>' >> ./default/theme.qrc
          
      - name: Other themes
        run: |
          for theme in ./*; do
            if [ -d "$theme" ]; then
              cd "$theme"
              count=`ls -1 *.ui 2>/dev/null | wc -l`
              if [ $count != 0 ] ; then
                echo "Found UI file for theme $theme"
                if [ ! -e "version" ] ; then
                  echo "Version file was missing!"
                  echo '1' > version
                fi
                if [ ! -e "theme.qrc" ] ; then
                  echo "QRC file was missing"
                  echo '<!DOCTYPE RCC><RCC version="1.0">' > theme.qrc
                  echo "<qresource prefix=\"/base/themes/$theme\">" >> theme.qrc
                  for i in *.ui;
                  do
                    echo "$i"
                    echo "    <file>$i</file>" >> theme.qrc
                  done
                  echo '    <file>version</file>' >> theme.qrc
                  echo '</qresource>' >> theme.qrc
                  echo '</RCC>' >> theme.qrc
                fi
              fi
              cd ..
            fi
          done

      - name: compile RCC
        run: |
          cd default
          rcc -binary theme.qrc -o theme.rcc
          
      - name: Upload Artifact
        uses: actions/upload-artifact@master
        with:
          name: compiled-themes
          path: ${{github.workspace}}/
